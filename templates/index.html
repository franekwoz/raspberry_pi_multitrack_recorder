<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Multitrack Recorder</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="section" id="device-section">
    <h2>Device</h2>
    <div class="device-options">
      <label><input type="radio" name="device" value="xr18" checked> XR18</label>
      <label><input type="radio" name="device" value="x32"> X32</label>
    </div>
  </div>

  <div class="section" id="record-section">
    <h2><img src="/static/icons/mic.svg" style="width:1.2em;vertical-align:middle;margin-right:0.4em;"> Record</h2>
    <input type="text" id="filename-input" placeholder="Enter file name (optional)" />
    <button id="btn-record" title="Record">
      <img src="/static/icons/record.svg" alt="Record" />
    </button>
    <button id="btn-pause" disabled title="Pause">
      <img src="/static/icons/pause.svg" alt="Pause" />
    </button>
    <button id="btn-resume" disabled title="Resume">
      <img src="/static/icons/play.svg" alt="Resume" />
    </button>
    <button id="btn-stop-rec" disabled title="Stop & Save">
      <img src="/static/icons/stop.svg" alt="Stop & Save" />
    </button>
    <p id="status-rec"></p>
  </div>

  <div class="section" id="play-section">
    <h2><img src="/static/icons/music.svg" style="width:1.2em;vertical-align:middle;margin-right:0.4em;"> Play</h2>
    <select id="recording-list">
      {% for file in recordings %}
        <option value="{{ file }}">{{ file }}</option>
      {% endfor %}
    </select>
    <button id="btn-play" title="Play">
      <img src="/static/icons/play.svg" alt="Play" />
    </button>
    <button id="btn-rewind" disabled title="Go to Start">
      <img src="/static/icons/rewind.svg" alt="Rewind" />
    </button>
    <button id="btn-next" disabled title="Next">
      <img src="/static/icons/next.svg" alt="Next" />
    </button>
    <p id="status-play"></p>
    <div class="progress-container" style="margin-top:15px;">
      <div class="progress-wrapper">
        <div id="progress-bar" class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
          <div id="progress-handle" class="progress-handle"></div>
        </div>
        <div class="time-display">
          <span id="current-time">00:00</span>
          <span id="total-time">00:00</span>
        </div>
      </div>
    </div>
    <!-- <audio id="audio-player" style="display:none;"></audio> -->
  </div>

  <script>
    let currentFile = null;
    let isPlaying = false;
    let isRecording = false;
    let playTimer = null;
    let playStartTime = null;
    let playDuration = 0;

    // Record
    document.getElementById('btn-record').onclick = async () => {
      const btnRecord = document.getElementById('btn-record');
      const filename = document.getElementById('filename-input').value.trim();
      const device = document.querySelector('input[name="device"]:checked').value;
      if (!isRecording) {
        const res = await fetch('/record', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ filename, device })
        });
        const data = await res.json();
        if (data.status === 'recording') {
          document.getElementById('status-rec').innerText = 'Recording: ' + data.file;
          currentFile = data.file;
          btnRecord.innerText = 'Stop';
          document.getElementById('btn-pause').disabled = false;
          document.getElementById('btn-stop-rec').disabled = true;
          isRecording = true;
        }
      } else {
        // Stop recording
        await fetch('/stop', { method: 'POST' });
        document.getElementById('status-rec').innerText = 'Stopped';
        btnRecord.innerText = 'Record';
        document.getElementById('btn-pause').disabled = true;
        document.getElementById('btn-resume').disabled = true;
        document.getElementById('btn-stop-rec').disabled = true;
        isRecording = false;
        // reload file list
        location.reload();
      }
    };
    document.getElementById('btn-pause').onclick = async () => {
      await fetch('/pause', { method: 'POST' });
      document.getElementById('status-rec').innerText = 'Paused';
      document.getElementById('btn-pause').disabled = true;
      document.getElementById('btn-resume').disabled = false;
    };
    document.getElementById('btn-resume').onclick = async () => {
      await fetch('/resume', { method: 'POST' });
      document.getElementById('status-rec').innerText = 'Recording: ' + currentFile;
      document.getElementById('btn-resume').disabled = true;
      document.getElementById('btn-pause').disabled = false;
    };
    document.getElementById('btn-stop-rec').onclick = async () => {
      // This button is now always disabled, but keep logic for safety
      await fetch('/stop', { method: 'POST' });
      document.getElementById('status-rec').innerText = 'Stopped';
      document.getElementById('btn-record').innerText = 'Record';
      document.getElementById('btn-pause').disabled = true;
      document.getElementById('btn-resume').disabled = true;
      document.getElementById('btn-stop-rec').disabled = true;
      isRecording = false;
      location.reload();
    };

    // Playback
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const progressHandle = document.getElementById('progress-handle');
    const currentTimeDisplay = document.getElementById('current-time');
    const totalTimeDisplay = document.getElementById('total-time');
    
    let isDragging = false;
    let currentPosition = 0;
    
    function formatTime(sec) {
      sec = Math.floor(sec);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function updateProgressBar(progress) {
      const percentage = Math.max(0, Math.min(100, progress * 100));
      progressFill.style.width = percentage + '%';
      progressHandle.style.left = percentage + '%';
    }

    function updateTimeDisplay(current, total) {
      currentTimeDisplay.textContent = formatTime(current);
      totalTimeDisplay.textContent = formatTime(total);
    }

    function updateProgressSim() {
      if (playStartTime === null || playDuration === 0) {
        updateProgressBar(0);
        updateTimeDisplay(0, 0);
        return;
      }
      const elapsed = Math.min((Date.now() - playStartTime) / 1000, playDuration);
      const progress = elapsed / playDuration;
      currentPosition = elapsed;
      
      if (!isDragging) {
        updateProgressBar(progress);
      }
      updateTimeDisplay(elapsed, playDuration);
      
      if (elapsed >= playDuration) {
        clearInterval(playTimer);
        playTimer = null;
        isPlaying = false;
        document.getElementById('btn-play').innerText = 'Play';
        document.getElementById('btn-rewind').disabled = true;
        document.getElementById('btn-next').disabled = true;
      }
    }

    // Progress bar click to seek
    function handleProgressClick(event) {
      if (playDuration === 0) return;
      
      const rect = progressBar.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const percentage = clickX / rect.width;
      const seekTime = percentage * playDuration;
      
      seekTo(seekTime);
    }

    // Seek functionality
    async function seekTo(time) {
      if (!isPlaying || playDuration === 0) return;
      
      const seekPercentage = time / playDuration;
      currentPosition = time;
      playStartTime = Date.now() - (time * 1000);
      
      updateProgressBar(seekPercentage);
      updateTimeDisplay(time, playDuration);
      
      // Send seek command to backend
      try {
        const response = await fetch('/seek', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ 
            filename: currentFile, 
            position: time,
            device: document.querySelector('input[name="device"]:checked').value
          })
        });
        
        const result = await response.json();
        if (result.status === 'error') {
          console.warn('Seek not fully supported:', result.message);
          // Update status to show seek limitation
          document.getElementById('status-play').innerText = 'Playing: ' + currentFile + ' (Seek: restart from beginning)';
        }
      } catch (error) {
        console.error('Seek failed:', error);
        // Fallback: just update the visual progress
        document.getElementById('status-play').innerText = 'Playing: ' + currentFile + ' (Visual seek only)';
      }
    }

    // Progress bar drag functionality
    function handleMouseDown(event) {
      if (playDuration === 0) return;
      isDragging = true;
      progressBar.style.cursor = 'grabbing';
      handleMouseMove(event);
    }

    function handleMouseMove(event) {
      if (!isDragging || playDuration === 0) return;
      
      const rect = progressBar.getBoundingClientRect();
      const mouseX = event.clientX - rect.left;
      const percentage = Math.max(0, Math.min(1, mouseX / rect.width));
      const seekTime = percentage * playDuration;
      
      updateProgressBar(percentage);
      updateTimeDisplay(seekTime, playDuration);
    }

    function handleMouseUp() {
      if (!isDragging) return;
      isDragging = false;
      progressBar.style.cursor = 'pointer';
      
      if (playDuration > 0) {
        const percentage = parseFloat(progressFill.style.width) / 100;
        const seekTime = percentage * playDuration;
        seekTo(seekTime);
      }
    }

    // Event listeners for progress bar
    progressBar.addEventListener('click', handleProgressClick);
    progressBar.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);

    document.getElementById('btn-play').onclick = async () => {
      const btnPlay = document.getElementById('btn-play');
      const sel = document.getElementById('recording-list');
      if (!isPlaying) {
        currentFile = sel.value;
        const device = document.querySelector('input[name="device"]:checked').value;
        // Get duration
        const durRes = await fetch(`/duration/${encodeURIComponent(currentFile)}`);
        const durData = await durRes.json();
        if (!durData.duration) {
          document.getElementById('status-play').innerText = 'Could not get duration';
          return;
        }
        playDuration = durData.duration;
        playStartTime = Date.now();
        updateProgressSim();
        playTimer = setInterval(updateProgressSim, 200);
        // POST to /play
        const res = await fetch('/play', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ filename: currentFile, device })
        });
        const data = await res.json();
        if (data.status === 'playing') {
          document.getElementById('status-play').innerText = 'Playing: ' + data.file;
          document.getElementById('btn-rewind').disabled = false;
          document.getElementById('btn-next').disabled = false;
          btnPlay.innerText = 'Stop';
          isPlaying = true;
        }
      } else {
        // Stop playback
        if (playTimer) { clearInterval(playTimer); playTimer = null; }
        playStartTime = null;
        playDuration = 0;
        await fetch('/stop', { method: 'POST' });
        document.getElementById('status-play').innerText = 'Stopped';
        document.getElementById('btn-rewind').disabled = true;
        document.getElementById('btn-next').disabled = true;
        btnPlay.innerText = 'Play';
        isPlaying = false;
        updateProgressSim();
      }
    };
    document.getElementById('btn-rewind').onclick = async () => {
      if (playTimer) { clearInterval(playTimer); playTimer = null; }
      playStartTime = Date.now();
      updateProgressSim();
      playTimer = setInterval(updateProgressSim, 200);
      await fetch('/rewind', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ current: currentFile }) });
      document.getElementById('status-play').innerText = 'Rewound';
      document.getElementById('btn-play').innerText = 'Stop';
      isPlaying = true;
    };
    document.getElementById('btn-next').onclick = async () => {
      const sel = document.getElementById('recording-list');
      const device = document.querySelector('input[name="device"]:checked').value;
      const res = await fetch('/next', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ current: currentFile }) });
      const data = await res.json();
      if (data.next) {
        currentFile = data.next;
        sel.value = currentFile;
        // Get duration for next file
        const durRes = await fetch(`/duration/${encodeURIComponent(currentFile)}`);
        const durData = await durRes.json();
        if (!durData.duration) {
          document.getElementById('status-play').innerText = 'Could not get duration';
          return;
        }
        playDuration = durData.duration;
        playStartTime = Date.now();
        updateProgressSim();
        playTimer = setInterval(updateProgressSim, 200);
        await fetch('/stop', { method: 'POST' });
        await fetch('/play', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: currentFile, device }) });
        document.getElementById('status-play').innerText = 'Next: ' + currentFile;
        document.getElementById('btn-play').innerText = 'Stop';
        isPlaying = true;
      }
    };
  </script>
</body>
</html>